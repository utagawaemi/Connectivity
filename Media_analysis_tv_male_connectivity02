%matplotlib inline

import os.path as op
import numpy as np
import matplotlib.pyplot as plt
from scipy import linalg

import mne
from mne.time_frequency import tfr_morlet, psd_multitaper
from mne.connectivity import spectral_connectivity

import csv

IDs = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12']

cname = 'male'
data_path = '/Users/emi/Desktop/media_TBS/media2/adj_tv/'
save_path = '/Users/emi/Desktop/media_TBS/media2/'

for i in range(len(IDs)):  

    sname = IDs[i]
    fname = data_path + cname + sname + '_tv_adj.set'
    mon = mne.channels.read_montage(kind = 'standard_1020') 
    aw = mne.io.read_epochs_eeglab(fname,montage=mon,
                                  eog=('EOG1', 'EOG2'))

    #for i in range(len(IDs)):  

    #sname = IDs[i]
    #fname = data_path + cname +sname + '_tv_adj.set'
    
    picks = mne.pick_types(aw.info, meg=False, eeg=True, eog=False, stim=False)  #読み込むチャンネルを設定
    
    aw_S1 = aw['TV']
    
    #### theta波 4-7Hz : Baseline
    fmin, fmax = 4., 7.
    sfreq = aw_S1.info['sfreq'] 
    
    tmin = 0.3  # exclude the baseline period
    tmax = 0.5
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
         aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
         faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_Nbas_theta000-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める


    tmin = 0.5  # exclude the baseline period
    tmax = 0.7
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_S1_theta000-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める

        
    tmin = 0.7  # exclude the baseline period
    tmax = 0.9
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_S1_theta200-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める

        
    tmin = 0.9  # exclude the baseline period
    tmax = 1.1
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_S1_theta400-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める

        
    tmin = 1.1  # exclude the baseline period
    tmax = 1.3
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_S1_theta600-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める

        
    tmin = 1.3  # exclude the baseline period
    tmax = 1.5
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_S1_theta800-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める

        
        
    #### alpha波 4-7Hz : Baseline
    
    fmin, fmax = 8., 13.
    sfreq = aw_S1.info['sfreq'] 
    
    
    tmin = 0.3  # exclude the baseline period
    tmax = 0.5
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_Nbas_alpha000-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める

    tmin = 0.5  # exclude the baseline period
    tmax = 0.7
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_S1_alpha000-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める
        
        
    tmin = 0.7  # exclude the baseline period
    tmax = 0.9
    con, freqs, times, n_aw, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)

    fname_souce = save_path + cname + sname + '_tv_adj_S1_alpha200-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める        
        
        
    tmin = 0.9  # exclude the baseline period
    tmax = 1.1
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_S1_alpha400-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める
        
    tmin = 1.1  # exclude the baseline period
    tmax = 1.3
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_S1_alpha600-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める
        
    tmin = 1.3  # exclude the baseline period
    tmax = 1.5
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_S1_alpha800-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める
        
        
          # ### beta波 4-7Hz : Baseline
    
    fmin, fmax = 14., 30.
    sfreq = aw_S1.info['sfreq'] 
    
    tmin = 0.3  # exclude the baseline period
    tmax = 0.5
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_Nbas_beta000-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める
        
    tmin = 0.5  # exclude the baseline period
    tmax = 0.7
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)
    
    fname_souce = save_path + cname + sname + '_tv_adj_S1_beta000-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める

    tmin = 0.7  # exclude the baseline period
    tmax = 0.9
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)

    fname_souce = save_path + sname + cname + '_tv_adj_S1_beta200-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める
        
    tmin = 0.9  # exclude the baseline period
    tmax = 1.1
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)

    fname_souce = save_path + sname + cname + '_tv_adj_S1_beta400-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める
        
    tmin = 1.1  # exclude the baseline period
    tmax = 1.3
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)

    fname_souce = save_path + sname + cname + '_tv_adj_S1_beta600-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める

    tmin = 1.3  # exclude the baseline period
    tmax = 1.5
    con, freqs, times, n_epochs, n_tapers = spectral_connectivity(
        aw_S1, method='wpli2_debiased', mode='multitaper', sfreq=sfreq, fmin=fmin, fmax=fmax,
        faverage=True, tmin=tmin, tmax=tmax, mt_adaptive=False, n_jobs=1)

    fname_souce = save_path + sname + cname + '_tv_adj_S1_beta800-con.csv'
    with open(fname_souce, 'w') as f:
        writer = csv.writer(f, lineterminator='\n') # 改行コード（\n）を指定しておく
        writer.writerows(con[:28,:28,0]) # 2次元配列も書き込める
